<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
          "http://www.w3.org/TR/html4/loose.dtd">
<head>
    <script src='ffmpeg.min.js'></script>
</head>
<body>
    <video controls width="1280" height="720" id="wq" muted></video>
    <canvas id="canvas" width="1280" height="720" hidden></canvas>
    <p><button id=rqqw>Done</button></p>
    <p><span id=rqqwr></span></p>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        var rp;
        const rqqwr = document.getElementById('rqqwr');
        var streamq;
        var rpqqw = performance.now();
        const rpqw = setInterval(function () {
        }, 33);
        const ctx = canvas.getContext('2d');
        const rqqw = document.getElementById('rqqw');

        var wq = document.getElementById('wq');
        async function qw() {
            streamq = navigator.mediaDevices.getUserMedia({ audio: true, video: { width: 1280, height: 720, frameRate: { max: 60 }} })
                .then(function (stream) {
                    streamq = stream;
                    if ("srcObject" in wq) {
                        wq.srcObject = stream;
                    } else {
                        wq.src = window.URL.createObjectURL(stream);
                    }
                    wq.onloadedmetadata = function (e) {
                        wq.play();
                        setInterval(function () {
                            ctx.drawImage(wq, 0, 0, wq.width, wq.height);
                        }, 3);
                    };
                });
        } qw();
        wq.addEventListener("canplay", function () { qww(); })
    </script>
    <script>
        function qww() {
            var canvas = document.querySelector("canvas");

            // Optional frames per second argument.
            var wqq = [];

            console.log(streamq);
            var options = { mimeType: "video/webm" };
            mediaRecorder = new MediaRecorder(streamq, options);

            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start();

            function handleDataAvailable(event) {
                console.log("data-available");
                if (event.data.size > 0) {
                    wqq.push(event.data);
                    console.log(wqq);
                    download();
                } else {
                    // ...
                }
            }
            async function download() {
                var blob = new Blob(wqq, {
                    type: "video/webm"
                });
                const name = 'wq.webm';
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'concat_list.txt', 'file wq.webm');
                ffmpeg.FS('writeFile', name, new Uint8Array(await (new Blob(wqq).arrayBuffer())));
                await ffmpeg.run('-i', 'wq.webm', '-preset', 'ultrafast', '-r', '60', 'qw.mp4');
                const data = ffmpeg.FS('readFile', 'qw.mp4');

                const qe = document.getElementById('qe');
                wq.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                var url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                a.href = url;
                a.download = "qw.mp4";
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // demo: to download after 9sec
            rqqw.addEventListener("mousedown", function w() {
                console.log("stopping");
                mediaRecorder.stop();
            });
        }
    </script>
</body>
</html>
